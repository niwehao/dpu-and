# DPU Memory Defragmentation System

[![Build Status](https://img.shields.io/badge/build-passing-brightgreen)]()
[![License](https://img.shields.io/badge/license-MIT-blue)]()
[![Language](https://img.shields.io/badge/language-C-orange)]()

ä¸€ä¸ªé«˜æ•ˆçš„DPUï¼ˆData Processing Unitï¼‰å†…å­˜ç¢ç‰‡æ•´ç†ç³»ç»Ÿï¼Œä½¿ç”¨ä¼˜åŒ–çš„O(n)ç®—æ³•ï¼Œå¯ç‹¬ç«‹æµ‹è¯•æ— éœ€å†…æ ¸ç¼–è¯‘ã€‚

## ğŸ“‹ ç›®å½•

- [ç‰¹æ€§](#ç‰¹æ€§)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [ç®—æ³•ä¼˜åŒ–](#ç®—æ³•ä¼˜åŒ–)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [æµ‹è¯•](#æµ‹è¯•)
- [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
- [å·²ä¿®å¤çš„Bug](#å·²ä¿®å¤çš„bug)

## âœ¨ ç‰¹æ€§

- **O(n) æ—¶é—´å¤æ‚åº¦**ï¼šå•æ¬¡éå†å®Œæˆç¢ç‰‡æ•´ç†ï¼Œæ›¿ä»£åŸæœ‰çš„O(nÂ²)åµŒå¥—å¾ªç¯
- **æ­£ç¡®å¤„ç†ç¢ç‰‡ç§»åŠ¨**ï¼šè€ƒè™‘äº†ç¢ç‰‡ç§»åŠ¨åçš„ç©ºä½å¡«è¡¥é—®é¢˜
- **ä¼˜åŒ–çš„æ•°æ®ç»“æ„**ï¼šä½¿ç”¨æ•°ç»„ç¼“å­˜åˆ†ç¦»ç¢ç‰‡å’Œç©ºé—²é¡µï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡
- **ç‹¬ç«‹æµ‹è¯•æ¡†æ¶**ï¼šæ— éœ€ç¼–è¯‘å†…æ ¸å³å¯æµ‹è¯•ï¼ŒåŒ…å«å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- **å†…æ ¸å…¼å®¹è®¾è®¡**ï¼šä½¿ç”¨Linuxå†…æ ¸é£æ ¼çš„é“¾è¡¨ç»“æ„ï¼Œå¯ç›´æ¥ç”¨äºå†…æ ¸æ¨¡å—
- **è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯**ï¼šæä¾›ç¢ç‰‡æ˜ å°„å’Œè¿ç§»ç»Ÿè®¡

## ğŸ“ é¡¹ç›®ç»“æ„

```
dpu-and/
â”œâ”€â”€ include/              # å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ list.h           # Linuxé£æ ¼åŒå‘é“¾è¡¨å®ç°
â”‚   â””â”€â”€ dpu_defrag.h     # ç¢ç‰‡æ•´ç†API
â”œâ”€â”€ src/                 # æºä»£ç 
â”‚   â”œâ”€â”€ dpu_defrag.c     # æ ¸å¿ƒç¢ç‰‡æ•´ç†ç®—æ³•
â”‚   â””â”€â”€ main.c           # æ¼”ç¤ºç¨‹åº
â”œâ”€â”€ tests/               # æµ‹è¯•ä»£ç 
â”‚   â””â”€â”€ test_defrag.c    # å®Œæ•´æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ build/               # ç¼–è¯‘ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ bin/                 # å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ Makefile             # æ„å»ºç³»ç»Ÿ
â””â”€â”€ README.md            # æœ¬æ–‡æ¡£
```

## ğŸš€ ç®—æ³•ä¼˜åŒ–

### åŸå§‹ç®—æ³•çš„é—®é¢˜

åŸå§‹çš„åŒæŒ‡é’ˆç®—æ³•å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **åµŒå¥—å¾ªç¯**ï¼šå‰æŒ‡é’ˆå¤–å±‚å¾ªç¯ + åæŒ‡é’ˆå†…å±‚å¾ªç¯ = O(nÂ²) å¤æ‚åº¦
2. **æœªå¤„ç†ç¢ç‰‡ç§»åŠ¨åçš„ç©ºä½**ï¼šç¢ç‰‡è¿ç§»åï¼Œå…¶åŸä½ç½®å˜ä¸ºç©ºé—²ï¼Œä½†æœªè¢«æ­£ç¡®å¤„ç†
3. **é‡å¤æŸ¥æ‰¾**ï¼šæ¯æ¬¡éƒ½è¦ä»åå‘å‰æŸ¥æ‰¾çœŸç¢ç‰‡ï¼Œæ•ˆç‡ä½ä¸‹

```c
// åŸå§‹ç®—æ³•ï¼ˆæœ‰é—®é¢˜ï¼‰
while (front_pos != &region->fragments && back_pos != &region->fragments) {
    // åµŒå¥—whileå¾ªç¯ - O(nÂ²)
    while (back_pos != front_pos) {
        back_frag = list_entry(back_pos, struct dpu_fragment, list);
        if (back_frag->is_frag) {
            back_frag->new_pfn = front_frag->old_pfn;
            break;
        }
        back_pos = back_pos->prev;  // é‡å¤éå†
    }
}
```

### ä¼˜åŒ–åçš„ç®—æ³•

æ–°ç®—æ³•é‡‡ç”¨**å•éå† + æ•°ç»„åˆ†ç¦»**çš„ç­–ç•¥ï¼š

**æ ¸å¿ƒæ€æƒ³**ï¼š
1. ä¸€æ¬¡éå†é“¾è¡¨ï¼Œå°†ç¢ç‰‡å’Œç©ºé—²é¡µåˆ†åˆ«å­˜å…¥æ•°ç»„
2. ç¢ç‰‡åˆ†é…è¿ç»­çš„ä½PFNï¼ˆç´§å‡‘åœ¨å‰ï¼‰
3. ç©ºé—²é¡µåˆ†é…è¿ç»­çš„é«˜PFNï¼ˆæ¨åˆ°åé¢ï¼‰

**ä¼ªä»£ç **ï¼š
```
1. éå†é“¾è¡¨ï¼Œåˆ†ç¦»ç¢ç‰‡å’Œç©ºé—²é¡µåˆ°ä¸¤ä¸ªæ•°ç»„  // O(n)
2. ä¸ºæ‰€æœ‰ç¢ç‰‡åˆ†é…è¿ç»­PFN: start, start+1, start+2, ...  // O(frag_count)
3. ä¸ºæ‰€æœ‰ç©ºé—²é¡µåˆ†é…è¿ç»­PFN: start+frag_count, ...     // O(free_count)
```

**æ—¶é—´å¤æ‚åº¦**ï¼šO(n)ï¼Œå…¶ä¸­ n = frag_count + free_count

**ç©ºé—´å¤æ‚åº¦**ï¼šO(n)ï¼Œç”¨äºä¸´æ—¶æ•°ç»„

è¯¦è§ `src/dpu_defrag.c:dpu_defragment_region()` ä¸­çš„è¯¦ç»†æ³¨é‡Šã€‚

## ğŸ”§ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- GCC 4.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- GNU Make
- Linux/Unix ç³»ç»Ÿï¼ˆæˆ– WSLï¼‰

### ç¼–è¯‘

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd dpu-and

# ç¼–è¯‘æ‰€æœ‰ç¨‹åº
make

# æˆ–æŸ¥çœ‹å¯ç”¨å‘½ä»¤
make help
```

### è¿è¡Œæ¼”ç¤º

```bash
# è¿è¡Œæ¼”ç¤ºç¨‹åº
make demo
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•å¥—ä»¶
make test

# ä½¿ç”¨Valgrindæ£€æµ‹å†…å­˜æ³„æ¼
make valgrind
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹

```c
#include "dpu_defrag.h"

int main(void)
{
    struct dpu_region region;

    /* 1. åˆå§‹åŒ–åŒºåŸŸ */
    dpu_region_init(&region, 0x1000, 0x2000);

    /* 2. æ·»åŠ ç¢ç‰‡å’Œç©ºé—²é¡µ */
    dpu_fragment_add(&region, 0x1000, false);  // ç©ºé—²é¡µ
    dpu_fragment_add(&region, 0x1001, true);   // ç¢ç‰‡
    dpu_fragment_add(&region, 0x1002, false);  // ç©ºé—²é¡µ
    dpu_fragment_add(&region, 0x1003, true);   // ç¢ç‰‡

    /* 3. æ‰§è¡Œç¢ç‰‡æ•´ç† */
    dpu_defragment_region(&region);

    /* 4. æŸ¥çœ‹ç»“æœ */
    dpu_print_fragment_mapping(&region);

    /* 5. æ¸…ç†èµ„æº */
    dpu_region_clear(&region);

    return 0;
}
```

## ğŸ“š API æ–‡æ¡£

### æ ¸å¿ƒå‡½æ•°

#### `dpu_region_init`
```c
void dpu_region_init(struct dpu_region *region, pfn_t start_pfn, pfn_t end_pfn);
```
åˆå§‹åŒ–ä¸€ä¸ªå†…å­˜åŒºåŸŸã€‚

**å‚æ•°**ï¼š
- `region`ï¼šè¦åˆå§‹åŒ–çš„åŒºåŸŸæŒ‡é’ˆ
- `start_pfn`ï¼šèµ·å§‹é¡µå¸§å·
- `end_pfn`ï¼šç»“æŸé¡µå¸§å·

#### `dpu_fragment_add`
```c
struct dpu_fragment *dpu_fragment_add(struct dpu_region *region,
                                      pfn_t pfn,
                                      bool is_frag);
```
å‘åŒºåŸŸæ·»åŠ ä¸€ä¸ªç¢ç‰‡æˆ–ç©ºé—²é¡µã€‚

**å‚æ•°**ï¼š
- `region`ï¼šç›®æ ‡åŒºåŸŸ
- `pfn`ï¼šé¡µå¸§å·
- `is_frag`ï¼š`true` è¡¨ç¤ºçœŸç¢ç‰‡ï¼Œ`false` è¡¨ç¤ºç©ºé—²é¡µ

**è¿”å›å€¼**ï¼šæˆåŠŸè¿”å›ç¢ç‰‡æŒ‡é’ˆï¼Œå¤±è´¥è¿”å› `NULL`

#### `dpu_defragment_region`
```c
int dpu_defragment_region(struct dpu_region *region);
```
æ‰§è¡Œç¢ç‰‡æ•´ç†ï¼Œè®¡ç®—æœ€ä¼˜çš„é¡µé¢é‡æ˜ å°„ã€‚

**å‚æ•°**ï¼š
- `region`ï¼šè¦æ•´ç†çš„åŒºåŸŸ

**è¿”å›å€¼**ï¼šæˆåŠŸè¿”å› `0`ï¼Œå¤±è´¥è¿”å›è´Ÿæ•°é”™è¯¯ç 

**è¯´æ˜**ï¼š
- ç®—æ³•æ—¶é—´å¤æ‚åº¦ï¼šO(n)
- ç¢ç‰‡å°†è¢«ç´§å‡‘åˆ°åŒºåŸŸå¼€å§‹ä½ç½®
- ç©ºé—²é¡µå°†è¢«ç§»åŠ¨åˆ°åŒºåŸŸæœ«å°¾
- æ¯ä¸ªç¢ç‰‡çš„ `new_pfn` å­—æ®µå°†åŒ…å«ç›®æ ‡PFN

#### `dpu_region_clear`
```c
void dpu_region_clear(struct dpu_region *region);
```
æ¸…é™¤åŒºåŸŸä¸­çš„æ‰€æœ‰ç¢ç‰‡ï¼Œé‡Šæ”¾å†…å­˜ã€‚

#### `dpu_region_stats`
```c
void dpu_region_stats(struct dpu_region *region);
```
æ‰“å°åŒºåŸŸç»Ÿè®¡ä¿¡æ¯ã€‚

#### `dpu_print_fragment_mapping`
```c
void dpu_print_fragment_mapping(struct dpu_region *region);
```
æ‰“å°è¯¦ç»†çš„ç¢ç‰‡é‡æ˜ å°„ä¿¡æ¯ã€‚

### æ•°æ®ç»“æ„

#### `struct dpu_fragment`
```c
struct dpu_fragment {
    struct list_head list;   // é“¾è¡¨èŠ‚ç‚¹
    pfn_t old_pfn;           // åŸå§‹é¡µå¸§å·
    pfn_t new_pfn;           // ç›®æ ‡é¡µå¸§å·ï¼ˆæ•´ç†åï¼‰
    bool is_frag;            // true=çœŸç¢ç‰‡, false=ç©ºé—²é¡µ
    uint32_t size;           // é¡µæ•°ï¼ˆé¢„ç•™æ‰©å±•ï¼‰
};
```

#### `struct dpu_region`
```c
struct dpu_region {
    struct list_head fragments;  // ç¢ç‰‡é“¾è¡¨å¤´
    uint32_t total_count;        // æ€»æ¡ç›®æ•°
    uint32_t frag_count;         // ç¢ç‰‡æ•°é‡
    uint32_t free_count;         // ç©ºé—²é¡µæ•°é‡
    pfn_t start_pfn;             // èµ·å§‹PFN
    pfn_t end_pfn;               // ç»“æŸPFN
};
```

## ğŸ§ª æµ‹è¯•

æµ‹è¯•å¥—ä»¶åŒ…å«6ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–å„ç§åœºæ™¯ï¼š

| æµ‹è¯•ç”¨ä¾‹ | æè¿° | éªŒè¯ç‚¹ |
|---------|------|--------|
| test_basic_defragmentation | åŸºæœ¬äº¤æ›¿æ¨¡å¼ | ç¢ç‰‡æ­£ç¡®ç´§å‡‘åˆ°å¼€å§‹ä½ç½® |
| test_reversed_layout | åå‘å¸ƒå±€ï¼ˆç©ºé—²åœ¨å‰ï¼‰ | å¤„ç†æœ€åæƒ…å†µ |
| test_already_defragmented | å·²ä¼˜åŒ–å¸ƒå±€ | æ— éœ€è¿ç§»æ—¶çš„ä¼˜åŒ– |
| test_complex_fragmentation | å¤æ‚ç¢ç‰‡æ¨¡å¼ | å¤„ç†å¤æ‚çš„æ··åˆæ¨¡å¼ |
| test_single_fragment | å•ä¸€ç¢ç‰‡ | è¾¹ç•Œæ¡ä»¶ |
| test_large_scale | å¤§è§„æ¨¡æµ‹è¯•ï¼ˆ100é¡µï¼‰ | æ€§èƒ½å’Œæ­£ç¡®æ€§ |

è¿è¡Œæµ‹è¯•ï¼š
```bash
make test
```

ç¤ºä¾‹è¾“å‡ºï¼š
```
âœ“ PASS: Defragmentation completed successfully
âœ“ PASS: First fragment at correct position (1000)
âœ“ PASS: All 5 fragments compacted to positions 4000-4004
...
Total tests run: 20
Tests passed:    20
Tests failed:    0

âœ“ All tests passed!
```

## ğŸ“Š æ€§èƒ½åˆ†æ

### æ—¶é—´å¤æ‚åº¦å¯¹æ¯”

| åœºæ™¯ | åŸå§‹ç®—æ³• | ä¼˜åŒ–ç®—æ³• | æå‡ |
|------|---------|---------|-----|
| 100ä¸ªé¡µé¢ | O(10,000) | O(100) | 100x |
| 1000ä¸ªé¡µé¢ | O(1,000,000) | O(1,000) | 1000x |
| 10000ä¸ªé¡µé¢ | O(100,000,000) | O(10,000) | 10000x |

### å®é™…æµ‹è¯•ç»“æœ

åœ¨100é¡µäº¤æ›¿æ¨¡å¼æµ‹è¯•ä¸­ï¼š
- åŸå§‹ç®—æ³•ä¼°è®¡ï¼š~5000æ¬¡å¾ªç¯è¿­ä»£
- ä¼˜åŒ–ç®—æ³•å®é™…ï¼š100æ¬¡éå† + 100æ¬¡èµ‹å€¼ = 200æ¬¡æ“ä½œ
- **æ€§èƒ½æå‡ï¼š25å€**

## ğŸ› å·²ä¿®å¤çš„Bug

### 1. å‡½æ•°ç­¾åä¸ä¸€è‡´
**é—®é¢˜**ï¼šå¤´æ–‡ä»¶å£°æ˜ä¸å®ç°ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç»Ÿä¸€æ‰€æœ‰å‡½æ•°ç­¾å
- æ·»åŠ å®Œæ•´çš„å‡½æ•°åŸå‹å£°æ˜
- è§ `include/dpu_defrag.h`

### 2. å¤´æ–‡ä»¶åŒ…å«é—®é¢˜
**é—®é¢˜**ï¼šç¼ºå°‘å¿…è¦çš„å¤´æ–‡ä»¶ï¼Œç¼–è¯‘å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆ›å»º `include/list.h`ï¼šLinuxå†…æ ¸é£æ ¼é“¾è¡¨
- æ·»åŠ æ‰€æœ‰å¿…è¦çš„æ ‡å‡†åº“å¤´æ–‡ä»¶
- ä½¿ç”¨ `-Iinclude` ç¡®ä¿å¤´æ–‡ä»¶å¯è§

### 3. ç¢ç‰‡ç§»åŠ¨åç©ºä½æœªå¤„ç†
**é—®é¢˜**ï¼šåŸå§‹ç®—æ³•æœªè€ƒè™‘ç¢ç‰‡ç§»åŠ¨åï¼Œå…¶åŸä½ç½®å˜ä¸ºç©ºé—²çš„æƒ…å†µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨æ–°çš„åˆ†ç¦»ç­–ç•¥ï¼šå…ˆæ”¶é›†æ‰€æœ‰ç¢ç‰‡å’Œç©ºé—²é¡µ
- ç„¶åç»Ÿä¸€åˆ†é…æ–°çš„PFNï¼Œç¡®ä¿ç¢ç‰‡ç´§å‡‘
- è¿™æ ·è‡ªç„¶å¤„ç†äº†ç§»åŠ¨åçš„ç©ºä½é—®é¢˜

### 4. åµŒå¥—å¾ªç¯æ•ˆç‡ä½ä¸‹
**é—®é¢˜**ï¼šO(nÂ²) å¤æ‚åº¦ï¼Œå¤§è§„æ¨¡åœºæ™¯ä¸‹æ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ”¹ç”¨å•éå† + æ•°ç»„åˆ†ç¦»ç­–ç•¥
- æ—¶é—´å¤æ‚åº¦é™ä½åˆ° O(n)
- ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

## ğŸ”¨ æ„å»ºé€‰é¡¹

```bash
# åŸºæœ¬æ„å»º
make                 # ç¼–è¯‘æ‰€æœ‰ç¨‹åº
make all             # åŒä¸Š

# è¿è¡Œ
make demo            # æ„å»ºå¹¶è¿è¡Œæ¼”ç¤º
make test            # æ„å»ºå¹¶è¿è¡Œæµ‹è¯•

# è°ƒè¯•
make valgrind        # ä½¿ç”¨Valgrindæ£€æµ‹å†…å­˜æ³„æ¼

# æ¸…ç†
make clean           # åˆ é™¤æ‰€æœ‰æ„å»ºæ–‡ä»¶
make rebuild         # æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘

# å®‰è£…ï¼ˆå¯é€‰ï¼‰
sudo make install    # å®‰è£…åˆ° /usr/local/bin
sudo make uninstall  # å¸è½½

# å¸®åŠ©
make help            # æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤
```

## ğŸ” ä»£ç é£æ ¼

æœ¬é¡¹ç›®éµå¾ªLinuxå†…æ ¸ç¼–ç é£æ ¼ï¼š
- ä½¿ç”¨Tabç¼©è¿›ï¼ˆ8ä¸ªç©ºæ ¼å®½åº¦ï¼‰
- å‡½æ•°åä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”
- ç»“æ„ä½“ä½¿ç”¨ `struct` å‰ç¼€
- è¯¦ç»†çš„å‡½æ•°å’Œç»“æ„ä½“æ³¨é‡Š

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡Issueåé¦ˆã€‚

---

**æ³¨æ„**ï¼šæ­¤é¡¹ç›®è®¾è®¡ä¸ºç‹¬ç«‹çš„ç”¨æˆ·ç©ºé—´æµ‹è¯•å·¥å…·ï¼Œä¹Ÿå¯ä»¥è½»æ¾é›†æˆåˆ°Linuxå†…æ ¸æ¨¡å—ä¸­ã€‚å¦‚éœ€ç”¨äºå†…æ ¸ï¼Œåªéœ€å°† `malloc/free` æ›¿æ¢ä¸º `kmalloc/kfree`ï¼Œå¹¶ç§»é™¤ `stdio.h` ç›¸å…³çš„æ‰“å°å‡½æ•°å³å¯ã€‚
